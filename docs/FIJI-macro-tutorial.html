<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Writing Your First ImageJ Macro – ImageJ Macro Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-985aa47af68dae11cd4d235c71fb941e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dfb324f25d9b1687192fa8be62ac8f9c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      ImageJ Macro Workshop
      </li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">ImageJ Macro Workshop</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-a-macro" id="toc-what-is-a-macro" class="nav-link active" data-scroll-target="#what-is-a-macro">🧠 What is a Macro?</a></li>
  <li><a href="#tips-before-writing-your-first-macro" id="toc-tips-before-writing-your-first-macro" class="nav-link" data-scroll-target="#tips-before-writing-your-first-macro">✅ Tips Before Writing Your First Macro</a></li>
  <li><a href="#lets-create-a-macro" id="toc-lets-create-a-macro" class="nav-link" data-scroll-target="#lets-create-a-macro">✏️ Let’s Create a Macro</a></li>
  <li><a href="#lets-create-a-macro---a-bit-more" id="toc-lets-create-a-macro---a-bit-more" class="nav-link" data-scroll-target="#lets-create-a-macro---a-bit-more">✏️ Let’s Create a Macro - A Bit More…</a></li>
  <li><a href="#making-a-macro-generic" id="toc-making-a-macro-generic" class="nav-link" data-scroll-target="#making-a-macro-generic">🔥 Making a Macro Generic</a></li>
  <li><a href="#saving-results-using-getdirectory" id="toc-saving-results-using-getdirectory" class="nav-link" data-scroll-target="#saving-results-using-getdirectory">📂 Saving Results using getDirectory()</a></li>
  <li><a href="#making-the-macro-more-flexible" id="toc-making-the-macro-more-flexible" class="nav-link" data-scroll-target="#making-the-macro-more-flexible">🔄 Making the Macro More Flexible</a></li>
  <li><a href="#adding-comments" id="toc-adding-comments" class="nav-link" data-scroll-target="#adding-comments">💬 Adding Comments</a></li>
  <li><a href="#pausing-your-macro" id="toc-pausing-your-macro" class="nav-link" data-scroll-target="#pausing-your-macro">⏸️ Pausing Your Macro</a></li>
  <li><a href="#using-loops-and-conditional-statements" id="toc-using-loops-and-conditional-statements" class="nav-link" data-scroll-target="#using-loops-and-conditional-statements">🌀 Using Loops and Conditional Statements</a>
  <ul>
  <li><a href="#for-loops" id="toc-for-loops" class="nav-link" data-scroll-target="#for-loops">For Loops</a></li>
  <li><a href="#if-else-statements" id="toc-if-else-statements" class="nav-link" data-scroll-target="#if-else-statements">If Else Statements</a></li>
  <li><a href="#formatting-loops-and-conditions" id="toc-formatting-loops-and-conditions" class="nav-link" data-scroll-target="#formatting-loops-and-conditions">Formatting Loops and Conditions</a></li>
  </ul></li>
  <li><a href="#working-with-the-results-table" id="toc-working-with-the-results-table" class="nav-link" data-scroll-target="#working-with-the-results-table">📊 Working with the Results Table</a>
  <ul>
  <li><a href="#controlling-output-with-setmeasurements" id="toc-controlling-output-with-setmeasurements" class="nav-link" data-scroll-target="#controlling-output-with-setmeasurements">📐 Controlling Output with setMeasurements()</a></li>
  </ul></li>
  <li><a href="#bonus-merging-channels" id="toc-bonus-merging-channels" class="nav-link" data-scroll-target="#bonus-merging-channels">🌈 Bonus: Merging Channels</a></li>
  <li><a href="#exiting-the-macro" id="toc-exiting-the-macro" class="nav-link" data-scroll-target="#exiting-the-macro">🏁 Exiting the Macro</a></li>
  <li><a href="#batch-processing-folders-of-images" id="toc-batch-processing-folders-of-images" class="nav-link" data-scroll-target="#batch-processing-folders-of-images">📂 Batch Processing Folders of Images</a></li>
  <li><a href="#final-touches" id="toc-final-touches" class="nav-link" data-scroll-target="#final-touches">📖 Final Touches</a>
  <ul>
  <li><a href="#add-a-license" id="toc-add-a-license" class="nav-link" data-scroll-target="#add-a-license">📄 Add a License</a></li>
  <li><a href="#sharing-your-code" id="toc-sharing-your-code" class="nav-link" data-scroll-target="#sharing-your-code">📄 Sharing Your Code</a></li>
  </ul></li>
  <li><a href="#troubleshooting" id="toc-troubleshooting" class="nav-link" data-scroll-target="#troubleshooting">🛠️ Troubleshooting</a></li>
  <li><a href="#a-note-about-.lif-files" id="toc-a-note-about-.lif-files" class="nav-link" data-scroll-target="#a-note-about-.lif-files">📦 A note about .lif files</a></li>
  <li><a href="#explore-my-macro-collection" id="toc-explore-my-macro-collection" class="nav-link" data-scroll-target="#explore-my-macro-collection">🔗 Explore My Macro Collection</a></li>
  <li><a href="#feedback" id="toc-feedback" class="nav-link" data-scroll-target="#feedback">Feedback</a></li>
  <li><a href="#contacts" id="toc-contacts" class="nav-link" data-scroll-target="#contacts">Contacts</a></li>
  <li><a href="#license" id="toc-license" class="nav-link" data-scroll-target="#license">LICENSE</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Writing Your First ImageJ Macro</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="what-is-a-macro" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-macro">🧠 What is a Macro?</h2>
<p>A macro is an automated input sequence that imitates keystrokes or mouse actions. Instead of clicking around manually, you can write a macro to:</p>
<ul>
<li><p>Repeat tasks on many images. How many times do you click split channels &gt; max projection over and over…</p></li>
<li><p>Streamline analysis and saving of results</p></li>
<li><p>Automate/Semi-automate analysis</p></li>
<li><p>Build reproducible analysis pipelines</p></li>
</ul>
<p>In FIJI, you write macros in a special scripting language called the ijm language. You do not need to know how to ‘code’ to generate a macro in FIJI. However, learning some basics of macro syntax and workflow can improve the capacity to modify, debug (errors happen all too often), and fully automate analysis routines.</p>
<div class="callout callout-style-default callout-note callout-titled" title="">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The IJM language was actually the first coding language I learnt. It is a great language to learn for beginner coders or the experienced!</p>
</div>
</div>
<hr>
</section>
<section id="tips-before-writing-your-first-macro" class="level2">
<h2 class="anchored" data-anchor-id="tips-before-writing-your-first-macro">✅ Tips Before Writing Your First Macro</h2>
<ul>
<li>Coding is unforgiving. It needs to be a certain structure to work well.</li>
</ul>
<ol type="1">
<li><p><strong>Spelling</strong> is critical (files and file would specify different variables).</p></li>
<li><p><strong>Capital Letters</strong> are important (Image1 is not the same as image1)</p></li>
<li><p>Use <strong>comments</strong> to help you (and others) understand your code. Comments start a line with // and are in green. These are not executed in the code.</p></li>
<li><p>Each line ends with ;</p></li>
<li><p>ImageJ is open source (free) and people will help you if you have a question</p>
<ul>
<li>Stack Overflow</li>
<li>Image.SC</li>
</ul></li>
</ol>
<p>Don’t post your own data unless necessary (Use ImageJ sample images)</p>
<pre><code>    🔎 File &gt; Open Samples</code></pre>
<div class="callout callout-style-default callout-note callout-titled" title="">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>I clearly wrote this a few years ago… ChatGPT is also a great place to get help.</p>
</div>
</div>
<ul>
<li><p>Use the Macro Recorder to capture your actions as code.</p>
<pre><code>  🔎 Plugins &gt; Macros &gt; Record...</code></pre></li>
<li><p>Test code on one image first.</p></li>
<li><p>Save the macro with the .ijm extension.</p></li>
</ul>
<hr>
</section>
<section id="lets-create-a-macro" class="level2">
<h2 class="anchored" data-anchor-id="lets-create-a-macro">✏️ Let’s Create a Macro</h2>
<p>Let’s write a macro, a small one first. Go to this folder and download the <a href="https://github.com/MarnieMaddock/FIJI-macro-tutorial/tree/main/sample-images">sample images</a>.</p>
<ol type="1">
<li><p>Open FIJI</p></li>
<li><p>Drag and drop the sample Image “sample-image1” into FIJI</p></li>
<li><p>🔎 Plugins &gt; Macros &gt; Record…</p></li>
</ol>
<div class="gray-box">
<pre><code>A Record Window will pop-up</code></pre>
</div>
<p>The record window is your best friend. It will record all the actions you take in FIJI and convert them into code. This is a great way to learn how to write macros, as you can see the code that corresponds to each action you take.</p>
<ol start="4" type="1">
<li><p>Click on the opened image</p></li>
<li><p>🔎 Image &gt; Stacks &gt; Z Project…</p></li>
</ol>
<div class="gray-box">
<pre><code>run("Z Project...", "projection=[Max Intensity]");</code></pre>
</div>
<ol start="6" type="1">
<li>🔎 Image &gt; Colour &gt; Split Channels</li>
</ol>
<div class="gray-box">
<pre><code>run("Split Channels");</code></pre>
</div>
<ol start="7" type="1">
<li>Click on Recorder Window. Click Create</li>
</ol>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section1.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<ol start="8" type="1">
<li><p>Open a second Image (sample-image2)</p></li>
<li><p>Click Run. So quick!</p></li>
<li><p>Save the new macro. 🔎 File &gt; Save As… &gt; max-projection_split-channels.ijm</p></li>
</ol>
<p>✅ Done!</p>
<hr>
</section>
<section id="lets-create-a-macro---a-bit-more" class="level2">
<h2 class="anchored" data-anchor-id="lets-create-a-macro---a-bit-more">✏️ Let’s Create a Macro - A Bit More…</h2>
<p>Now we are going to add a bit more complexity. Close all open widnows in FIJI, we need a fresh start.</p>
<ol type="1">
<li><p>Drag and Drop Image “sample-image1” into FIJI</p></li>
<li><p>🔎 Plugins &gt; Macros &gt; Record…</p></li>
<li><p>Select opened image by clicking on it. Then 🔎 Image &gt; Stacks &gt; Z Project… &gt; Max Intensity</p></li>
</ol>
<div class="gray-box">
<pre><code>run("Z Project...", "projection=[Max Intensity]");</code></pre>
</div>
<ol start="4" type="1">
<li>🔎 Image &gt; Color &gt; Split Channels</li>
</ol>
<div class="gray-box">
<pre><code>run("Split Channels");</code></pre>
</div>
<ol start="5" type="1">
<li>Select Channel 3 (Red Channel)</li>
</ol>
<div class="gray-box">
<pre><code>selectImage("C3-MAX_sample-image1.tif");</code></pre>
</div>
<ol start="6" type="1">
<li>🔎 Process &gt; Filters &gt; Unsharp Mask… (Radius 1, Mask Weight 0.60)</li>
</ol>
<div class="gray-box">
<pre><code>run("Unsharp Mask...", "radius=1 mask=0.60");</code></pre>
</div>
<ol start="7" type="1">
<li>🔎 Process &gt; Binary &gt; Make Binary</li>
</ol>
<div class="gray-box">
<pre><code>setOption("BlackBackground", true);
run("Convert to Mask");</code></pre>
</div>
<ol start="8" type="1">
<li>🔎 Analyze &gt; Analyze Particles… (select options display results, clear results, summarize, add to manager, exclude on edges)</li>
</ol>
<div class="gray-box">
<pre><code>run("Analyze Particles...", "  show=Overlay display exclude clear summarize add");</code></pre>
</div>
<ol start="9" type="1">
<li>Select Window “Results”. 🔎 File &gt; Save As &gt; Results… &gt; Name results file. This filepath will be different for you.</li>
</ol>
<div class="gray-box">
<pre><code>saveAs("Results", "C:/Users/marni/ImageJ Macros/ImageJ Macro Tutorial/sample-images/Results.csv");</code></pre>
</div>
<ol start="10" type="1">
<li>Select Window “Summary”. 🔎 File &gt; Save As &gt; Results… &gt; Name summary file. This filepath will be different for you.</li>
</ol>
<div class="gray-box">
<pre><code>saveAs("Results", "C:/Users/marni/ImageJ Macros/ImageJ Macro Tutorial/sample-images/Summary.csv");</code></pre>
</div>
<ol start="11" type="1">
<li>Go to recorder, delete any accidental lines of code by highlighting them &gt; delete. Then press create.</li>
</ol>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section2.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<ol start="12" type="1">
<li><p>Close all windows except this macro. To close all open images we can do this quickly using one line of code in a new macro! 🔎 File &gt; New &gt; close(“*”); &gt; run.</p></li>
<li><p>Delete Results and Summary files from your folder.</p></li>
<li><p>Drag and drop the same image in (It works). You should see the saved csv files in the specified folder.</p></li>
<li><p>Close all windows except the macro window.</p></li>
<li><p>Drag and drop a new image in “sample-image2”. An error appears.</p></li>
</ol>
<div class="gray-box">
<pre><code>No Window with the title "sample-image2" found.</code></pre>
</div>
<p>The macro is looking for our first image (sample-image1) not the second (sample-image2).</p>
<p>💡 We need to make the code generic!</p>
<hr>
</section>
<section id="making-a-macro-generic" class="level2">
<h2 class="anchored" data-anchor-id="making-a-macro-generic">🔥 Making a Macro Generic</h2>
<p>This enables you to perform your macros, without having to specify the image name manually every time.</p>
<p>A reminder:</p>
<ul>
<li><p>When writing code in the ImageJ language all lines must end with a semi-colon (;)</p></li>
<li><p>Code is case sensitive (Image1 is different to image1).</p></li>
</ul>
<p>A lot of errors can be fixed by checking these two things.</p>
<p>Using the existing macro:</p>
<ol type="1">
<li>On the very first line add:</li>
</ol>
<div class="gray-box">
<pre><code>title = getTitle();</code></pre>
</div>
<p>getTitle() is a built-in function that returns the name of the currently active image.</p>
<p>title is a variable — it holds the result of the function.</p>
<p>The = sign assigns the value. Think of ‘title’ like a labeled box that now holds the image’s name. You can reuse this value later in your macro, for example, when saving results using the image name. Anywhere we have our image name – we can change to title…</p>
<p>💡 Tip: You can name your variables anything (like imgName, filename, etc.), but title is a good descriptive choice here since we’re storing the image title.</p>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="Rules for Naming Variables">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Rules for Naming Variables
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 40%">
<col style="width: 31%">
</colgroup>
<thead>
<tr class="header">
<th>Rule</th>
<th>Example</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1. Must start with a <strong>letter</strong></td>
<td><code>cellCount</code></td>
<td>✅ OK</td>
</tr>
<tr class="even">
<td>2. Can contain <strong>letters, numbers, or underscores</strong></td>
<td><code>image_01</code>, <code>threshold_level</code></td>
<td>✅ OK</td>
</tr>
<tr class="odd">
<td>3. <strong>Cannot contain spaces</strong></td>
<td>❌ <code>cell count</code></td>
<td>Use underscores or camelCase instead</td>
</tr>
<tr class="even">
<td>4. <strong>Cannot start with a number</strong></td>
<td>❌ <code>1stImage</code></td>
<td>✅ <code>firstImage</code></td>
</tr>
<tr class="odd">
<td>5. Avoid <strong>symbols or punctuation</strong></td>
<td>❌ <code>title!</code>, <code>my-variable.</code></td>
<td></td>
</tr>
<tr class="even">
<td>6. Case-sensitive</td>
<td><code>Title</code> ≠ <code>title</code></td>
<td><code>Title</code> and <code>title</code> are different</td>
</tr>
<tr class="odd">
<td>7. Avoid using built-in <strong>keywords or function names</strong></td>
<td>❌ <code>run</code>, <code>print</code>, <code>getTitle</code></td>
<td>These are reserved by ImageJ</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Tips for Good Variable names">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tips for Good Variable names
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 37%">
<col style="width: 62%">
</colgroup>
<thead>
<tr class="header">
<th>Tip</th>
<th>Why It Helps</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>✅ Use <strong>descriptive names</strong></td>
<td>e.g., <code>nucleiCount</code>, <code>imageTitle</code></td>
</tr>
<tr class="even">
<td>✅ Use <strong>camelCase</strong> or <code>snake_case</code> for readability</td>
<td>e.g., <code>cellArea</code>, <code>cell_area</code></td>
</tr>
<tr class="odd">
<td>✅ Be consistent across your macro</td>
<td>Makes your code easier to read and maintain</td>
</tr>
<tr class="even">
<td>❌ Avoid names like <code>x</code>, <code>y</code>, <code>a</code> unless for quick loops</td>
<td>Not informative</td>
</tr>
</tbody>
</table>
</div>
</div>
<ol start="2" type="1">
<li>Now we need to change the image name in the selectImage() line.</li>
</ol>
<div class="gray-box">
<pre><code>selectImage(“C3-MAX_” + title);</code></pre>
</div>
<p>The + sign is used to concatenate (join) strings (words in ” ” and variables) together. The string “C3-MAX_” is joined with the value of the variable title that we assigned at the start of the macro.</p>
<ol start="3" type="1">
<li>Open sample-Image1. Press Run. Check output files. The macro should run with no errors. Repeat for sample-Image2. Check output files.</li>
</ol>
<p>However…</p>
<p>Currently our results are being saved as “Results” and “Summary”, and these are being overwritten every time we run a new image. It is best to include the image name when saving the results, so that they are unique and do not get overwritten.</p>
<ol start="4" type="1">
<li>We can change:</li>
</ol>
<div class="gray-box">
<pre><code>saveAs("Results", "C:/Users/marni/ImageJ Macros/ImageJ Macro Tutorial/sample-images/Results.csv");</code></pre>
</div>
<p>To:</p>
<div class="gray-box">
<pre><code>selectWindow("Results");
saveAs("Results", "C:/Users/marni/ImageJ Macros/ImageJ Macro Tutorial/sample-images/" + "Results_" + title + ".csv");</code></pre>
</div>
<p>Here we are selecting the Results Window, and saving it to the destination folder with the name Results_sample-image1.csv or Results_sample-image2.csv. The same can be done for the Summary file.</p>
<ol start="5" type="1">
<li>Change the Summary file name to:</li>
</ol>
<div class="gray-box">
<pre><code>selectWindow("Summary");
saveAs("Results", "C:/Users/marni/ImageJ Macros/ImageJ Macro Tutorial/sample-images/" + "Summary_" + title + ".csv");</code></pre>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section3.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Strings are pieces of text. In ImageJ, strings are enclosed in double quotes (“). For example,”Hello World” is a string. You can concatenate strings using the + operator.</p>
<p>Variables are like boxes that hold values. You can create a variable to store a string, number, or other data types. For example, <code>myString = "Hello"</code> creates a variable called myString that holds the string “Hello”.</p>
<p>Variables do not need to be in quotes. Strings must be in quotes. A variable can be a string, but a string cannot be a variable. For example, <code>myString = "Hello"</code> is correct, but <code>"myString" = "Hello"</code> is incorrect.</p>
</div>
</div>
<ol start="6" type="1">
<li>Save the macro. Close all windows except the macro window. Drag and drop sample-image1 and sample-image2 into FIJI. Check the output files.</li>
</ol>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/output-files1.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="500"></p>
</figure>
</div>
<div class="callout callout-style-default callout-caution callout-titled" title="Fix the Mistake">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fix the Mistake
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a macro that stores a name in a variable and prints it. What is wrong with the following code? What is the error message?</p>
<pre><code>"name" = "Mitochondria";
print(name);</code></pre>
<details>
<summary>
🔍 Show Answer and Explanation
</summary>
<p>Macro Error:</p>
<p>Statement cannot begin with ‘=’ in line 1.</p>
<pre><code>"name" = "Mitochondria";  // ❌ Invalid syntax
name = "Mitochondria";  // ✅ Variable name is unquoted
print(name);  // ✅ Prints the value of the variable</code></pre>
<p>This error occurs because the macro is trying to assign a value to a string literal (the quoted text “name”) instead of a variable. In ImageJ macros, variable names should not be enclosed in quotes.</p>
</details>
<p>Now try this code:</p>
<pre><code>name = mitochondria
print(name)</code></pre>
<p>What error message do you expect?</p>
<details>
<summary>
🔍 Show Answer and Explanation
</summary>
<p>Macro Error: Undefined variable in line 1.</p>
<p>This error occurs because the macro is trying to assign a variable (mitochondria - note it is not in quotes) to a variable name (name). Because we haven’t defined the variable mitochondria, the macro doesn’t know what it is. In ImageJ macros, variable names should be defined before they are used. To fix this, we can either define the variable mitochondria or use a string literal (e.g., “mitochondria”) instead.</p>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled" title="Fix the Mistake">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fix the Mistake
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new macro with the following code:</p>
<pre><code>title = "my image"
print(title);</code></pre>
<p>What is wrong with the code? What is the error message?</p>
<details>
<summary>
🔍 Show Answer and Explanation
</summary>
<p>Macro Error: ‘;’ expected in line 1.</p>
<pre><code>title = "my image"  // ❌ Missing semicolon
title = "my image";  // ✅ Corrected code
print(title);  // ✅ Prints the value of the variable</code></pre>
<p>This error occurs because the macro is missing a semicolon at the end of the first line. In ImageJ macros, each statement must end with a semicolon.</p>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled" title="Fix the Mistake">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fix the Mistake
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new macro with the following code:</p>
<pre><code>directory = getDirectory("Choose Directory";
print(directory);</code></pre>
<p>What is wrong with the code? What is the error message?</p>
<details>
<summary>
🔍 Show Answer and Explanation
</summary>
<p>Macro Error: `‘)’ expected in line 1.</p>
<pre><code>directory = getDirectory("Choose Directory";  // ❌ Missing closing parenthesis
directory = getDirectory("Choose Directory");  // ✅ Corrected code
print(directory);  // ✅ Prints the value of the variable</code></pre>
<p>This error occurs because the macro is missing a closing parenthesis at the end of the first line. In ImageJ macros, each function call must have matching parentheses.</p>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled" title="Fix the Mistake">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fix the Mistake
</div>
</div>
<div class="callout-body-container callout-body">
<p>Create a new macro with the following code:</p>
<pre><code>threshold = 128;
threshold = "Low";
print(threshold);</code></pre>
<p>What type of value does threshold hold?</p>
<details>
<summary>
🔍 Show Answer and Explanation
</summary>
<p>Initially, threshold holds a number (128)…</p>
<p>…but then it is overwritten with a string “Low”.</p>
<p>Result: the final print statement will output a string, not a number. This won’t crash the macro, but it can lead to unexpected behavior if you later try to use threshold as a number (e.g., in math operations).</p>
</details>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled" title="Fix the Mistake">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fix the Mistake
</div>
</div>
<div class="callout-body-container callout-body">
<p>Try this macro code:</p>
<pre><code>run = "Start";
print(run);</code></pre>
<p>Will this code work? What colour will the text be?</p>
<details>
<summary>
🔍 Show Answer and Explanation
</summary>
<p>Macro Error: ‘(’ expected in line 1.</p>
<p><code>run</code> is a built-in function name in ImageJ macros — using it as a variable name overwrites or shadows that function. You can tell its a function name because it is written in gold. Variables should be black. The macro is expecting the function run() and so is why the error message shows ‘(’ expected.</p>
<p>❌ Don’t use built-in function names like:</p>
<ul>
<li><p>run</p></li>
<li><p>print</p></li>
<li><p>getTitle</p></li>
<li><p>showMessage</p></li>
</ul>
<p>✅ Instead, choose a different name:</p>
<pre><code>run_status = "Start";
print(run_status);</code></pre>
</details>
</div>
</div>
<p>Great, I now have my files saved in this filepath. I can now run this macro on any image I want, and it will save the results in the same file path with the image name included. This is a great start to automating analysis. But, what if I want to use this macro and save the results in a different folder each time it is run?</p>
<hr>
</section>
<section id="saving-results-using-getdirectory" class="level2">
<h2 class="anchored" data-anchor-id="saving-results-using-getdirectory">📂 Saving Results using getDirectory()</h2>
<p>We can use the built-in function getDirectory() to specify the folder we want to save our results in. This function allows us to select a directory using a file dialog box. This way, we do not need to write out the entire filepath each time we run the macro for different folders.</p>
<ol type="1">
<li>Using the existing macro, at the start add:</li>
</ol>
<div class="gray-box">
<pre><code>dir = getDirectory("Choose Destination Directory");</code></pre>
</div>
<p>This will open a file dialog box that allows you to select the destination folder. The selected folder filepath will be stored in the variable dir.</p>
<ol start="2" type="1">
<li>Now we need to change the saveAs() lines to:</li>
</ol>
<div class="gray-box">
<pre><code>selectWindow("Results");
saveAs("Results", dir + "Results_" + title + ".csv");
selectWindow("Summary");
saveAs("Results", dir + "Summary_" + title + ".csv");</code></pre>
</div>
<p>This simplifies things a lot. Now, when you run the macro, it will prompt you to select a destination folder. The results will be saved in that folder with the image name included.</p>
<ol start="3" type="1">
<li>Save the macro. Close all windows except the macro window. Drag and drop sample-image1 and sample-image2 into FIJI. Run the macro on both images. Try saving the results in a different folder to the one you originally specified to see if it works.</li>
</ol>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section4.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Tip: Saving Other Types of Results">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip: Saving Other Types of Results
</div>
</div>
<div class="callout-body-container callout-body">
<p>Often, you may want to save other types of results, such as images or text files. You can use the same method to specify the directory and filename. For example to save a processed image as a tiff file:</p>
<pre><code>saveAs("Tiff", dir + "processed-image_" + title + ".tif");</code></pre>
<p>Or to save the regions of interest (ROIs) selected by analyze particles:</p>
<pre><code>roiManager("Save", dir + title + "_RoiSet.zip");</code></pre>
<p>📌 Tip: Always ensure you run <code>saveAs()</code> <strong>after</strong> processing is complete, and that the correct image window is active.</p>
</div>
</div>
<p>But wait! What if I want to count objects in a different channel? I.e. for one experiment my object of interest was imaged in C2, and some in C3. I want to be able to specify which channel I want to count objects in, without having to change the code each time manually.</p>
<hr>
</section>
<section id="making-the-macro-more-flexible" class="level2">
<h2 class="anchored" data-anchor-id="making-the-macro-more-flexible">🔄 Making the Macro More Flexible</h2>
<p>We can use the built-in function getNumber() to prompt the user for input. This allows us to specify which channel we want to count objects in.</p>
<ol type="1">
<li>Using the existing macro, before the line title = getTitle(); add:</li>
</ol>
<div class="gray-box">
<pre><code>Dialog.create("Specify Channel Numbers");
Dialog.addNumber("Channel number for analyze particles", 1);
Dialog.show();

channel_num = Dialog.getNumber();</code></pre>
</div>
<p>This will open a dialog box that prompts the user to enter a number. The entered number will be stored in the variable channel_num. This number will be used to specify which channel to analyze and count objects from.</p>
<p>Dialog.create() creates a new dialog box with the title “Specify Channel Numbers”. Dialog.addNumber() adds a number input field to the dialog box with the label “Channel number for analyze particles” and a default value of 1. Dialog.show() displays the dialog box to the user. channel_num = Dialog.getNumber() retrieves the number entered by the user in the dialog box.</p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section5.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<ol start="2" type="1">
<li>Now we need to change the selectImage() line from:</li>
</ol>
<div class="gray-box">
<pre><code>selectImage("C3-MAX_" + title);</code></pre>
</div>
<p>to:</p>
<div class="gray-box">
<pre><code>selectImage("C" + channel_num + "-MAX_" + title);</code></pre>
</div>
<p>This will select the channel specified by the user in the dialog box. The + sign concatenates the string “C” with the value of channel_num and the string “-MAX_” with the value of title.</p>
<ol start="3" type="1">
<li>Save the macro. Close all windows except the macro window. Drag and drop sample-image1 into FIJI. Run the macro by choosing 1 as the channel number. Then run the macro again by choosing 2 when prompted. Check the output files.</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled" title="Tip: Dialog Input Types and How to Save Their Values">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip: Dialog Input Types and How to Save Their Values
</div>
</div>
<div class="callout-body-container callout-body">
<p>ImageJ macros support a wide range of dialog inputs using <code>Dialog.add...()</code> functions.<br>
Here’s a summary of commonly used options and how to save their values:</p>
<div style="overflow-x: auto;">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Function</th>
<th>Description</th>
<th>Example</th>
<th>Saving the Input</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Dialog.addNumber()</code></td>
<td>Numeric input field</td>
<td><code>Dialog.addNumber("Channel number", 1)</code></td>
<td><code>channel_num = Dialog.getNumber();</code></td>
</tr>
<tr class="even">
<td><code>Dialog.addString()</code></td>
<td>Text input field</td>
<td><code>Dialog.addString("Channel name", "Mitochondria")</code></td>
<td><code>channel_name = Dialog.getString();</code></td>
</tr>
<tr class="odd">
<td><code>Dialog.addCheckbox()</code></td>
<td>Checkbox (true/false)</td>
<td><code>Dialog.addCheckbox("Enhance Contrast", true)</code></td>
<td><code>enhance = Dialog.getCheckbox();</code></td>
</tr>
<tr class="even">
<td><code>Dialog.addChoice()</code></td>
<td>Dropdown menu</td>
<td><code>Dialog.addChoice("Options", newArray("opt1", "opt2"), "opt1")</code></td>
<td><code>selected_option = Dialog.getChoice();</code></td>
</tr>
<tr class="odd">
<td><code>Dialog.addHelp()</code></td>
<td>Help button with URL</td>
<td><code>Dialog.addHelp("https://...")</code></td>
<td><em>(No value to retrieve)</em></td>
</tr>
<tr class="even">
<td><code>Dialog.addSlider()</code></td>
<td>Slider input (min, max, default)</td>
<td><code>Dialog.addSlider("Particle Size", 1, 1000, 312)</code></td>
<td><code>particle_size = Dialog.getSlider();</code></td>
</tr>
<tr class="odd">
<td><code>Dialog.addRadioButtonGroup()</code></td>
<td>Radio button grid</td>
<td><code>Dialog.addRadioButtonGroup("Cities", newArray("NY", "Paris"), 2, 1, "Paris")</code></td>
<td><code>selected_city = Dialog.getRadioButton();</code></td>
</tr>
</tbody>
</table>
</div>
<p>You can mix and match these input types in a single dialog box to collect multiple parameters from the user.</p>
<p>📌 Don’t forget to call <code>Dialog.show();</code> before retrieving values!</p>
<p>These tools help create rich, interactive macro interfaces to guide the user through parameter selection. You can mix these in a single dialog box to collect different types of input from the user. Give it a try by adding these options to your macro, and see what they look like.</p>
<div class="gray-box">
<pre><code>Dialog.create("Create a dialog box");
Dialog.addNumber("Channel number for analyze particles", 1);
Dialog.addString("Channel name", "Mitochondria")
Dialog.addCheckbox("Enhance Contrast", true);
Dialog.addChoice("Multiple Options", newArray("option1","option2","option3"), "option1");
Dialog.addHelp("https://github.com/MarnieMaddock?tab=repositories");
Dialog.addSlider("Particle Size", 1, 1000, 312);

items = newArray("New York", "London", "Paris", "Tokyo");
Dialog.addRadioButtonGroup("Cities", items, 2, 2, "Paris");
Dialog.show();</code></pre>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: Customize the Dialog">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: Customize the Dialog
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let’s create a dialog box that allows the user to specify different options for the analyze particle function and extract the options selected by the user by assigning the options to variables. Then run analyze particles using the options selected by the user.</p>
<p>The user should be able to:</p>
<ul>
<li>Set the <strong>minimum size</strong> of particles to detect</li>
<li>Set the <strong>minimum circularity</strong> of particles to detect</li>
<li>Set the <strong>maximum size</strong> of particles to detect</li>
</ul>
<p>Use the dialog inputs to control how <code>run("Analyze Particles...")</code> is executed. Look at your previous analyze particles function as a guide on the format. Remember to concatenate the strings and variables together using + to create the correct command.</p>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>// Create dialog box
Dialog.create("Analyze Particles Options"); // Dialog box pop-up
Dialog.addNumber("Minimum Particle Size", 0); // Default set to 0
Dialog.addNumber("Minimum circularity", 0); // Default set to 0
Dialog.addNumber("Maximum circularity", 1); // Default set to 1
Dialog.show(); // Show dialog box

// Get user input by svaing the options to variables
min_size = Dialog.getNumber(); // Get minimum size
min_circularity = Dialog.getNumber(); // Get minimum circularity
max_circularity = Dialog.getNumber(); // Get maximum circularity

// Build the options string using the numbers supplied
ap_options = "size=" + min_size + "-Infinity circularity=" + min_circularity + "-" + max_circularity + " show=Overlay display exclude clear summarize overlay add";

run("Analyze Particles...", ap_options);</code></pre>
<p>Test this out yourself. Change the minimum size, minimum circularity, and maximum circularity to see how it changes the results.</p>
</details>
</div>
</div>
<hr>
</section>
<section id="adding-comments" class="level2">
<h2 class="anchored" data-anchor-id="adding-comments">💬 Adding Comments</h2>
<p>Now that we have written a working macro, we need to add some comments so that others, and your future self can understand what your code is doing. Comments can be added by using // at the start of the line. These will not be read as excutable code. This is a good habit to get into when writing code, as it makes it easier to understand and debug later on.</p>
<p>First start by adding comments to specify that this code is to be run in FIJI. I then add my name, date, and a title of the macro.</p>
<div class="gray-box">
<pre><code>// USAGE: Use in FIJI
//
// Author: Marnie L Maddock (University of Wollongong)
// mmaddock@uow.edu.au, mlm715@uowmail.edu.au
// 5.07.2024
// Count number of Objects in a Channel</code></pre>
</div>
<p>Longer comments can be added by using /* and */ at the start and end of a large piece of text. This is useful for adding longer descriptions of what the macro does, or how to use it.</p>
<div class="gray-box">
<pre><code>/*
This macro will take an image and:
1. Run a max projection,
2. Split the channels,
3. Unsharp mask, 
4. Convert to binary,
5. Analyze particles (count objects),
6. Save the results and summary files.
*/</code></pre>
</div>
<p>Now we need to add comments to each section of the code. For example:</p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section6.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section7.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<hr>
</section>
<section id="pausing-your-macro" class="level2">
<h2 class="anchored" data-anchor-id="pausing-your-macro">⏸️ Pausing Your Macro</h2>
<p>When writing macros, sometimes you don’t want everything to run automatically. You might want to:</p>
<ul>
<li><p>Pause and let the user inspect an image manually</p></li>
<li><p>Allow manual ROI drawing before continuing</p></li>
<li><p>Add a checkpoint to confirm results before the next step</p></li>
<li><p>Give instructions to the user</p></li>
</ul>
<p>This is where waitForUser() comes in — it temporarily pauses the macro until the user clicks OK.</p>
<p>✅ Basic use:</p>
<div class="gray-box">
<pre><code>waitForUser("Click OK when ready to continue");</code></pre>
</div>
<p>This will pause the macro and show a dialog with the message “Click OK when ready to continue”. Write this in a new macro window and see what happens when you press run.</p>
<p>✅ With a title and message:</p>
<div class="gray-box">
<pre><code>waitForUser("Step 2", "Now draw an ROI on the image. Click OK when finished.");</code></pre>
</div>
<p>This will show a dialog with the title “Step 2” and the message “Now draw an ROI on the image. Click OK when finished.” The macro will pause until you click OK.</p>
<p>Create a new macro file and copy in the following:</p>
<div class="gray-box">
<pre><code>run("Blobs (25K)");
run("8-bit");

// Instruct user to draw a selection
waitForUser("Step 1", "Please draw an ROI (e.g. a rectangle) on the image and then click OK.");

// Continue with analysis
run("Measure");</code></pre>
</div>
<p>This macro will open the Blobs (25K) image, convert it to 8-bit, and then pause to let the user draw a selection. After clicking OK, it will measure the selected area.</p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section9.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<hr>
<p>Another way to add a pause is to use the showMessage() function. Use showMessage() when you want to:</p>
<ul>
<li><p>Give instructions or context before running a step</p></li>
<li><p>Confirm parameters before analysis</p></li>
<li><p>Display a simple summary to the user</p></li>
<li><p>Provide educational or progress prompts</p></li>
</ul>
<p>Unlike waitForUser(), it’s often used just to notify, not necessarily pause deeply for user interaction.</p>
<p>✅ Simple message</p>
<div class="gray-box">
<pre><code>showMessage("This macro will convert your image to binary.");</code></pre>
</div>
<p>Try this out yourself:</p>
<div class="gray-box">
<pre><code>showMessage("Step 1", "This step will threshold your image.\nPlease ensure it's 8-bit grayscale.");</code></pre>
</div>
<p>First argument is the title, second is the message. You can use slash n for line breaks.</p>
<hr>
<p>There is one more way to pause a macro. We can use the wait() function to automtically pause the macro for a specified amount of time.</p>
<p>Use wait() when you want to:</p>
<ul>
<li><p>Pause briefly between steps for visual effect</p></li>
<li><p>Give the user a moment to see changes before moving on</p></li>
<li><p>Allow your computer to complete processing before moving on (important when svaing large images or files)</p></li>
</ul>
<p>Unlike waitForUser() or showMessage(), wait() does not require the user to click OK — it just pauses for a set time in <strong>milliseconds</strong> and moves on automatically.</p>
<div class="gray-box">
<pre><code>wait(1000);  // Waits for 1 second
wait(500);   // Waits for 0.5 seconds
wait(3000);  // Waits for 3 seconds</code></pre>
</div>
<p>Give this code a try:</p>
<div class="gray-box">
<pre><code>run("Blobs (25K)");
run("8-bit");

run("Gaussian Blur...", "sigma=2");

// Pause for 3 seconds before the next step
wait(3000);

run("Make Binary");</code></pre>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>wait()</code> is also useful for debugging, as it allows you to see the image before the next step. This is one of my favourite debugging tools.</p>
</div>
</div>
<hr>
</section>
<section id="using-loops-and-conditional-statements" class="level2">
<h2 class="anchored" data-anchor-id="using-loops-and-conditional-statements">🌀 Using Loops and Conditional Statements</h2>
<p>In macro writing, <strong>loops</strong> and <strong>conditions</strong> are essential tools that let you repeat actions, check for specific conditions, and apply different steps depending on the data. These loops start with for, and conditions start with if or else.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Loops and Conditions">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Loops and Conditions
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 38%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th>Structure</th>
<th>What it Does</th>
<th>Example Use Case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>for</code> loop</td>
<td>Repeats a block of code for a list of items</td>
<td>Loop through channels or image slices</td>
</tr>
<tr class="even">
<td><code>if</code></td>
<td>Checks a condition and runs code if true</td>
<td>Only threshold if a checkbox is selected</td>
</tr>
<tr class="odd">
<td><code>else</code></td>
<td>Runs alternative code if the <code>if</code> fails</td>
<td>Do a different filter if one is unchecked</td>
</tr>
<tr class="even">
<td><code>if (...) &amp;&amp; (...)</code></td>
<td>Logical AND — all conditions must be true</td>
<td>Only run if two options are selected</td>
</tr>
<tr class="odd">
<td><code>if (...) || (...)</code></td>
<td>Logical OR — at least one condition is true</td>
<td>Run if <strong>either</strong> contrast or sharpness is checked</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="for-loops" class="level3">
<h3 class="anchored" data-anchor-id="for-loops">For Loops</h3>
<p>Loops help us repeat the same action multiple times. Let’s write a loop that prints “Hello!” three times.</p>
<ol type="1">
<li><p>Open a new macro window in FIJI</p></li>
<li><p>Write the following code:</p></li>
</ol>
<div class="gray-box">
<pre><code>for (i = 0; i &lt; 3; i++) {
    print("Hello!");
}</code></pre>
</div>
<p>What output did you get? Hello! Should have printed 3x in the log.</p>
<details>
<summary>
🔍 Show Explanation
</summary>
<p>What does <code>for (i = 0; i &lt; 3; i++)</code> mean? This is a for loop — a way to repeat something multiple times.</p>
<ul>
<li><p><code>for</code> This starts the loop</p></li>
<li><p><code>i</code> Is a variable. It acts like a counter that keeps track of which loop number you’re on. i is short for index or iterator — it’s just a tradition in programming. It is common to use i, j, k, etc. as loop variables, but you could choose any name. e.g.&nbsp;<code>counter</code>, <code>index</code>, etc: <code>for (counter = 0; counter &lt; 3; counter++)</code></p></li>
<li><p><code>i = 0</code> Start by setting i to 0 — this is the first count</p></li>
<li><p><code>i &lt; 3</code> Keep repeating as long as it is less than 3</p></li>
<li><p><code>i++</code> After each loop, add 1 to i (same as i = i + 1)</p></li>
<li><p>Think of i as what number am I on right now?</p></li>
</ul>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Loop</th>
<th>Value of i</th>
<th>What gets printed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1st loop</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>2nd loop</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>3rd loop</td>
<td>2</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>After that, i becomes 3, and the loop stops — because the condition i &lt; 3 is no longer true.</p>
</details>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: What Does `i` Do?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: What Does <code>i</code> Do?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let’s explore what the variable <code>i</code> does in a loop.</p>
<p>Try running this macro:</p>
<pre><code>for (i = 0; i &lt; 5; i++) {
    print("Loop number: " + i);
}</code></pre>
<p>Before you run it, can you guess what it will print?</p>
<details>
<summary>
🔍 Show Solution
</summary>
<p>This loop runs 5 times. The value of i changes with each loop:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="an">Loop number:</span><span class="co"> 0</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="an">Loop number:</span><span class="co"> 1</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="an">Loop number:</span><span class="co"> 2</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="an">Loop number:</span><span class="co"> 3</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="an">Loop number:</span><span class="co"> 4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>Let’s try another example:</p>
<pre><code>for (i = 1; i &lt;= 4; i++) {
    print("Saving image as: Image_" + i + ".tif");
}</code></pre>
<p>What do you think this will print?</p>
<details>
<summary>
🔍 Show Solution
</summary>
<p>This loop runs 4 times. The value of i changes with each loop:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="an">Saving image as:</span><span class="co"> Image_1.tif</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="an">Saving image as:</span><span class="co"> Image_2.tif</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="an">Saving image as:</span><span class="co"> Image_3.tif</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="an">Saving image as:</span><span class="co"> Image_4.tif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>How could you alter the loop to save images as Image_1.tif, Image_2.tif, Image_3.tif, and Image_4.tif to a directory?</p>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>for (i = 1; i &lt;= 4; i++) {
    saveAs("Tiff", dir + "Image_" + i + ".tif");
    print("Saving image as: Image_" + i + ".tif");
}</code></pre>
<p>This code will return an error if the directory is not defined. But this is how you could apply this concept in working macros.</p>
</details>
<p>Now let’s use a loop to access <strong>items from an array</strong>. Imagine you have an array of stains used in your experiment:</p>
<pre><code>stains = newArray("DAPI", "BRN3A", "ISLET1");</code></pre>
<p>Write a loop that prints each stain name. Fill in the blanks.</p>
<pre><code>stains = newArray("BRN3A", "ISLET1", "DAPI");

for (i = 0; i &lt; ________; i++) {
    print("Processing stain: " + _______);
}</code></pre>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>stains = newArray("BRN3A", "ISLET1", "DAPI");

for (i = 0; i &lt; stains.length; i++) {
    print("Processing stain: " + stains[i]);
}</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="an">Processing stain:</span><span class="co"> BRN3A</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="an">Processing stain:</span><span class="co"> ISLET1</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="an">Processing stain:</span><span class="co"> DAPI</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Breakdown:</p>
<ul>
<li><p><code>i = 0</code> starts at the first item in the array. stains[0] is “BRN3A”</p></li>
<li><p><code>i &lt; stains.length</code> keeps going as long as i is less than the total number of items in the array (3 in this case).</p></li>
<li><p><code>stains.length</code> is the number of items (in this case: 3). By adding <code>.length</code> to a variable, you can find out how many items are in that variable. <code>.length</code> is a property of an array in ImageJ macros (and many programming languages).</p></li>
<li><p><code>i++</code> increases i by 1 after each loop iteration (moves to the next stain).</p></li>
</ul>
</details>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: Apply Filters to Multiple Channels">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: Apply Filters to Multiple Channels
</div>
</div>
<div class="callout-body-container callout-body">
<p>You’ve split a multi-channel image and want to process only selected channels, like C1 and C3.</p>
<p>Use a loop to:</p>
<ol type="1">
<li>Split the channels using <code>Split Channels</code><br>
</li>
<li>Loop through two channels e.g.&nbsp;(C1 and C3)<br>
</li>
<li>Apply a <strong>Median filter</strong> and <strong>Make Binary</strong> to each</li>
</ol>
<p>Fill in the blanks below:</p>
<pre><code>title = ___________;  // Get the image title
run("____________");  // Split channels into separate windows

// List of channels you want to process 
channelsToProcess = newArray("1", "3");

for (i = 0; i &lt; ___________; i++) {
    channel = ____________;
    // Construct the window name based on how ImageJ names split channels
    fullTitle = "C" + channel + "-" + _______;
    
    selectWindow(fullTitle);
    
    run("Median...", "radius=2");
    setOption("BlackBackground", true);
    run("Convert to Mask");
}</code></pre>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>// Get the original image title (e.g., "sample.tif")
title = getTitle();

// Split the image into channels (creates C1-&lt;title&gt;, C2-&lt;title&gt;, etc.)
run("Split Channels");

// List of channels you want to process 
channelsToProcess = newArray("1", "3");

for (i = 0; i &lt; channelsToProcess.length; i++) {
    channel = channelsToProcess[i];
    
    // Construct the window name based on how ImageJ names split channels
    fullTitle = "C" + channel + "-" + title;
    
    selectWindow(fullTitle);
    
    run("Median...", "radius=2");
    setOption("BlackBackground", true);
    run("Convert to Mask");
}</code></pre>
<p>This code will process only the specified channels (C1 and C3) by applying a median filter and converting them to binary masks. The loop iterates through the channelsToProcess array, constructs the window name for each channel, and applies the desired processing steps.</p>
</details>
</div>
</div>
</section>
<section id="if-else-statements" class="level3">
<h3 class="anchored" data-anchor-id="if-else-statements">If Else Statements</h3>
<p>If statements are used to check if a condition is true or false. If the condition is true, the code inside the if statement will run. This is key for customising your workflow based on your data.</p>
<p>An if/else statement lets you run one block of code if a condition is true, and a different block if it’s false. For example:</p>
<div class="gray-box">
<pre><code>if (slices &gt; 1) {
    run("Z Project...", "projection=[Max Intensity]");
    rename(title);
} else {
    print("Single slice image, no projection needed");
}</code></pre>
</div>
<p>This code checks if the number of slices is greater than 1. If it is, it runs a max projection and renames the image. If not, it prints a message saying no projection is needed.</p>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: Use If Else Statements">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: Use If Else Statements
</div>
</div>
<div class="callout-body-container callout-body">
<p>Your task is to write a macro that:</p>
<ul>
<li><p>Gets the number of Z slices in the image.</p></li>
<li><p>If there are more than one, runs a Z projection.</p></li>
<li><p>Otherwise, split channels.</p></li>
</ul>
<p>Test it on sample-image1.tif and sample-image3.tif</p>
<pre><code>// Get image dimensions, where 'slices' is the number of Z slices
Stack.getDimensions(width, height, channels, slices, frames);

// Replace the placeholder condition and commands as needed
if (__________) {
    run("Z Project...", "projection=[Max Intensity]");
    print("Applied Z Projection");
} else {
    run("_________");
    print("Split channels");
}</code></pre>
<p>🧠 Hint: Replace the blank with a condition that checks if slices is greater than 1.</p>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>Stack.getDimensions(width, height, channels, slices, frames);

if (slices &gt; 1) {
    run("Z Project...", "projection=[Max Intensity]");
    print("Applied Z Projection");
} else {
    run("Split Channels");
    print("Split channels");
}</code></pre>
<p>This code checks the number of slices in the image. If there are more than one slice, it applies a Z projection. If not, it splits the channels.</p>
</details>
</div>
</div>
<p>Let’s try and integrate some concepts we explored earlier:</p>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: Apply a Filter Based on User Input">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: Apply a Filter Based on User Input
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let’s give the user a choice! Open sample-image1.tif. Use a dialog box to let the user enter a number between 1 and 10.</p>
<ul>
<li>If the number is <strong>5 or greater</strong>, apply a <strong>Unsharp Mask</strong><br>
</li>
<li>If it’s <strong>less than 5</strong>, apply a <strong>Split Channels</strong></li>
</ul>
<p>Fill in the blanks:</p>
<pre><code>Dialog.create("Choose a filter");
Dialog.________("Enter a number (1–10)", 5);
Dialog.show();

value = Dialog.getNumber();

if (__________________) {
    run("Unsharp Mask...", "radius=1 mask=0.60");
    print("Applied Unsharp Mask");
} ______ {
    run("Split Channels");
    print("Applied Split Channels");
}</code></pre>
<p>🧠 This is a great way to customize processing based on user-defined settings. To write is something is greater than or equal to something else, use &gt;=. To write is something is less than or equal to something else, use &lt;=.</p>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>Dialog.create("Choose a filter");
Dialog.addNumber("Enter a number (1–10)", 5);
Dialog.show();

value = Dialog.getNumber();

if (value &gt;= 5) {
    run("Unsharp Mask...", "radius=1 mask=0.60");
    print("Applied Unsharp Mask");
} else {
    run("Split Channels");
    print("Applied Split Channels");
}</code></pre>
<p>This code creates a dialog box that prompts the user to enter a number between 1 and 10. If the number is 5 or greater (&gt;=), it applies Unsharp Mask. If the number is less than 5, it applies split channels.</p>
</details>
<p>Let’s try another one. Let the user choose between two image filters using a dropdown menu by creating a dialog box.</p>
<ul>
<li>If the user selects <strong>“Gaussian”</strong>, apply a <strong>Gaussian Blur</strong></li>
<li>If the user selects <strong>“Median”</strong>, apply a <strong>Median Filter</strong></li>
</ul>
<p>Complete the macro below:</p>
<pre><code>Dialog.create("Choose a filter type");
Dialog.________("Select filter", __________("Gaussian", "Median"), "Gaussian");
Dialog._____();

choice = Dialog.getChoice();

if (________________________) {
    run("Gaussian Blur...", "sigma=2");
    print("Applied Gaussian Blur");
} else {
    run("Median...", "radius=2");
    print("Applied Median Filter");
}</code></pre>
<p>🧠 Use == to compare the selected value with a string like “Gaussian”.</p>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>Dialog.create("Choose a filter type");
Dialog.addChoice("Select filter", newArray("Gaussian", "Median"), "Gaussian");
Dialog.show();

choice = Dialog.getChoice();

if (choice == "Gaussian") {
    run("Gaussian Blur...", "sigma=2");
    print("Applied Gaussian Blur");
} else {
    run("Median...", "radius=2");
    print("Applied Median Filter");
}</code></pre>
<p>This code creates a dialog box that lets the user choose between “Gaussian” and “Median” filters. If the user selects “Gaussian”, it applies a Gaussian Blur. If the user selects “Median”, it applies a Median Filter.</p>
</details>
<p>What if you don’t want to apply a filter? We need a none option. To do this we can use an else if statement. This is a way to check multiple conditions in a row.</p>
<p>Update your macro so the user can choose from <strong>three options</strong>:</p>
<ul>
<li><strong>“Gaussian”</strong> → apply a Gaussian Blur<br>
</li>
<li><strong>“Median”</strong> → apply a Median Filter<br>
</li>
<li><strong>“None”</strong> → apply no filter, just print a message</li>
</ul>
<p>Use <code>else if</code> to handle the third case.</p>
<pre><code>Dialog.create("Choose a filter type");
Dialog.addChoice("Select filter", _______________________________________, "Gaussian");
Dialog.show();

choice = Dialog.getChoice();

if (choice == "Gaussian") {
    run(________________, "sigma=2");
    print("Applied Gaussian Blur");
} else if (choice == "__________") {
    run("______________", "radius=2");
    print("Applied Median Filter");
} else {
    print("No filter applied.");
}</code></pre>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>Dialog.create("Choose a filter type");
Dialog.addChoice("Select filter", newArray("Gaussian", "Median", "None"), "Gaussian");
Dialog.show();

choice = Dialog.getChoice();

if (choice == "Gaussian") {
    run("Gaussian Blur...", "sigma=2");
    print("Applied Gaussian Blur");
} else if (choice == "Median") {
    run("Median...", "radius=2");
    print("Applied Median Filter");
} else {
    print("No filter applied.");
}</code></pre>
<p>This code creates a dialog box that lets the user choose between “Gaussian”, “Median”, and “None” filters. If the user selects “Gaussian”, it applies a Gaussian Blur. If the user selects “Median”, it applies a Median Filter. If the user selects “None”, it prints a message saying no filter was applied.</p>
</details>
</div>
</div>
<p>The power of loops and conditions is that they allow you to create flexible and dynamic macros. You can adapt your code to different situations, making it more efficient and user-friendly. By combining both loops and conditions, you can create complex workflows that can handle a variety of tasks.</p>
<p>Let’s say you have 3 channels (e.g., C1, C2, C3) and you want to choose which filter to apply to each channel. Using sample-image3.tif.</p>
<ol type="1">
<li><p>Split image into separate channel windows (C1-…, C2-…, etc.)</p></li>
<li><p>Ask the user to select a filter type using Dialog.addChoice()</p></li>
<li><p>Create a list of channel numbers in an array (e.g., “1”, “2”, “3”)</p></li>
<li><p>Use a for loop to loop through each channel</p></li>
<li><p>Use if, else if, and else inside the loop to apply the chosen filter to each channel</p></li>
</ol>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: Apply a Chosen Filter to All Channels">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: Apply a Chosen Filter to All Channels
</div>
</div>
<div class="callout-body-container callout-body">
<p>Your task is to:</p>
<ol type="1">
<li>Ask the user which filter to apply: <code>"Gaussian"</code>, <code>"Median"</code>, or <code>"None"</code></li>
<li>Loop through channels <code>1</code> to <code>3</code></li>
<li>Apply the selected filter to <strong>each channel window</strong></li>
</ol>
<p>Fill in the blanks below:</p>
<pre><code>// Ask the user which filter to apply
Dialog.______("Filter Selection");
Dialog.______("Choose filter", newArray("Gaussian", "Median", "None"), "Gaussian");
Dialog.___();

choice = Dialog.________();

// List of channels
channels = newArray("1", "2", "3");
title = getTitle(); // Base title of the original image
run("Split Channels"); // Split channels into separate windows

// Loop through channels
for (i = _; i &lt; channels._____; i++) {
    channel = channels[i];
    fullTitle = "C" + channel + "-" + title;
    selectWindow(fullTitle);

    ___ (choice == "Gaussian") {
        run("Gaussian Blur...", "sigma=2");
        print("Applied Gaussian to C" + channel);
    } ______ ______ (choice == "Median") {
        run("Median...", "radius=2");
        print("Applied Median to C" + channel);
    } else {
        print("No filter applied to C" + channel);
    }
}</code></pre>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>// Ask the user which filter to apply
Dialog.create("Filter Selection");
Dialog.addChoice("Choose filter", newArray("Gaussian", "Median", "None"), "Gaussian");
Dialog.show();

choice = Dialog.getChoice();

// List of channels
channels = newArray("1", "2", "3");
title = getTitle(); // Base title of the original image
run("Split Channels"); // Split channels into separate windows

// Loop through channels
for (i = 0; i &lt; channels.length; i++) {
    channel = channels[i];
    fullTitle = "C" + channel + "-" + title;
    selectWindow(fullTitle);

    if (choice == "Gaussian") {
        run("Gaussian Blur...", "sigma=2");
        print("Applied Gaussian to C" + channel);
    } else if (choice == "Median") {
        run("Median...", "radius=2");
        print("Applied Median to C" + channel);
    } else {
        print("No filter applied to C" + channel);
    }
} // close bracket for for loop</code></pre>
<p><code>Dialog.addChoice(...)</code>: lets the user select a filter option</p>
<p><code>choice = Dialog.getChoice()</code>: stores that selection</p>
<p><code>channels = newArray(...)</code>: defines which channels to loop through</p>
<p><code>for (...)</code>: goes through each channel one at a time</p>
<p><code>selectWindow(...)</code>: activates each channel image window</p>
<p><code>if/else</code>: chooses what filter (if any) to apply</p>
<p>Give it a go trying different options.</p>
</details>
</div>
</div>
<p>Ok, but what if I want to apply different filters to different channels? Now we are entering the realm of channel-specific processing logic — where the user can apply different filters to different channels in a single macro. This is a fantastic way to combine:</p>
<p>✅ A for loop</p>
<p>✅ An if/else if decision tree</p>
<p>✅ A dialog-driven, per-channel configuration</p>
<p>Let’s say the user wants:</p>
<p>🟢 C1 → Apply Median filter</p>
<p>🔵 C2 → Apply Unsharp Mask</p>
<p>⚫ C3 → Apply Make Binary</p>
<p>We’ll create:</p>
<ol type="1">
<li><p>A dialog with three dropdowns, one per channel</p></li>
<li><p>A for loop to go through each channel</p></li>
<li><p>A separate filter choice for each channel using if / else if / else inside the loop</p></li>
</ol>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: Apply Different Filters Per Channel">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: Apply Different Filters Per Channel
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let the user choose <strong>a specific filter for each channel</strong> using dropdown menus, then loop through each channel and apply the correct filter.</p>
<pre><code>// === Create dialog with a dropdown for each channel ===
Dialog.create("Select Filter for Each Channel");

Dialog.addChoice("C1 Filter", newArray("Median", "Unsharp", "Binary", "None"), "Median");
Dialog.addChoice("C2 Filter", newArray("Median", "Unsharp", "Binary", "None"), "Unsharp");
Dialog.addChoice("C3 Filter", newArray("Median", "Unsharp", "Binary", "None"), "Binary");

Dialog.show();

// === Store choices for each channel ===
c1_filter = Dialog.__________;
c2_filter = Dialog.__________;
c3_filter = Dialog.__________;

// === Array of filters in the same order as channels ===
filters = newArray(________, _________, _________);
channels = newArray("1", "2", "3");
title = _________; // base image name
run("Split Channels"); // Split channels into separate windows

// === Loop through channels ===
for (_____;_________________;_______) {
    channel = channels[i];
    filter = filters[i];
    fullTitle = "C" + channel + "-" + title;

    selectWindow(fullTitle);

    if (filter ____ "Median") {
        run("Median...", "radius=2");
        print("Applied Median to C" + channel);
    } else if (filter ____ "Unsharp") {
        run("Unsharp Mask...", "radius=1 mask=0.6");
        print("Applied Unsharp Mask to C" + channel);
    } else if (filter ____"Binary") {
        run("Make Binary");
        print("Applied Binary to C" + channel);
    } else {
        print("No filter applied to C" + channel);
    }
}</code></pre>
<details>
<summary>
🔍 Solution
</summary>
<p>Let the user choose <strong>a specific filter for each channel</strong> using dropdown menus, then loop through each channel and apply the correct filter.</p>
<pre><code>// === Create dialog with a dropdown for each channel ===
Dialog.create("Select Filter for Each Channel");

Dialog.addChoice("C1 Filter", newArray("Median", "Unsharp", "Binary", "None"), "Median");
Dialog.addChoice("C2 Filter", newArray("Median", "Unsharp", "Binary", "None"), "Unsharp");
Dialog.addChoice("C3 Filter", newArray("Median", "Unsharp", "Binary", "None"), "Binary");

Dialog.show();

// === Store choices for each channel ===
c1_filter = Dialog.getChoice();
c2_filter = Dialog.getChoice();
c3_filter = Dialog.getChoice();

// === Array of filters in the same order as channels ===
filters = newArray(c1_filter, c2_filter, c3_filter);
channels = newArray("1", "2", "3");
title = getTitle(); // base image name
run("Split Channels"); // Split channels into separate windows

// === Loop through channels ===
for (i = 0; i &lt; channels.length; i++) {
    channel = channels[i];
    filter = filters[i];
    fullTitle = "C" + channel + "-" + title;

    selectWindow(fullTitle);

    if (filter == "Median") {
        run("Median...", "radius=2");
        print("Applied Median to C" + channel);
    } else if (filter == "Unsharp") {
        run("Unsharp Mask...", "radius=1 mask=0.6");
        print("Applied Unsharp Mask to C" + channel);
    } else if (filter == "Binary") {
        run("Make Binary");
        print("Applied Binary to C" + channel);
    } else {
        print("No filter applied to C" + channel);
    }
}</code></pre>
<p>3 dropdowns → user chooses a filter for each channel</p>
<p>The choices are saved into c1_filter, c2_filter, c3_filter</p>
<p>These are combined into an array: filters = newArray(…)</p>
<p>We then loop over the channels (C1, C2, C3) and apply the filter from filters[i]</p>
<p>if / else if / else applies the correct filter, or skips it</p>
<p>💡 Super flexible — you can later add more filters, more channels, or apply this to batch processing!</p>
</details>
</div>
</div>
</section>
<section id="formatting-loops-and-conditions" class="level3">
<h3 class="anchored" data-anchor-id="formatting-loops-and-conditions">Formatting Loops and Conditions</h3>
<p>When writing loops and conditions, it is important to format them correctly. Here are some tips:</p>
<ul>
<li><p><strong>Always check your condition:</strong> Ensure your comparison (like <code>slices &gt; 1</code>) makes sense for your data.</p></li>
<li><p><strong>Use proper indentation:</strong> It makes your code easier to read. Notice how the code inside the loop or condition is indented. This shows that it belongs to that loop or condition.</p></li>
<li><p><strong>Test both paths:</strong> Make sure your macro works when the condition is both true and false.</p></li>
<li><p><strong>Use comments:</strong> Add comments to explain what each part of your code does. This is especially helpful for complex loops and conditions.</p></li>
</ul>
<hr>
</section>
</section>
<section id="working-with-the-results-table" class="level2">
<h2 class="anchored" data-anchor-id="working-with-the-results-table">📊 Working with the Results Table</h2>
<p>The results table is a powerful tool in FIJI that allows you to store and analyze data from your images. You can use it to save measurements, counts, and other information about your images.</p>
<p>The Results Table is where ImageJ stores data from tools like:</p>
<ul>
<li><p>run(“Measure”)</p></li>
<li><p>Analyze Particles</p></li>
<li><p>ROI Manager measurements</p></li>
<li><p>Intensity profiles and other analysis outputs</p></li>
</ul>
<p>You can use macros to:</p>
<ul>
<li><p>Read and extract results</p></li>
<li><p>Modify values</p></li>
<li><p>Save tables to file</p></li>
<li><p>Loop through rows to perform calculations</p></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Useful Results Table Functions">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Useful Results Table Functions
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 37%">
<col style="width: 62%">
</colgroup>
<thead>
<tr class="header">
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>nResults</code></td>
<td>Returns number of rows in the Results Table</td>
</tr>
<tr class="even">
<td><code>getResult(column, row)</code></td>
<td>Gets the value from a specific cell</td>
</tr>
<tr class="odd">
<td><code>setResult(column, row, x)</code></td>
<td>Changes a value in the table</td>
</tr>
<tr class="even">
<td><code>resetResults()</code> &nbsp;Clears the entire table</td>
<td></td>
</tr>
<tr class="odd">
<td><code>saveAs("Results", path)</code></td>
<td>Saves results to a CSV file</td>
</tr>
<tr class="even">
<td><code>updateResults()</code></td>
<td>Refreshes the table to show changes</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>For example:</p>
<div class="gray-box">
<pre><code>run("Blobs (25K)");
run("8-bit");
run("Make Binary");
run("Analyze Particles...", "size=0-Infinity show=Overlay display clear summarize");

// Loop through Results Table
for (i = 0; i &lt; nResults; i++) {
    area = getResult("Area", i);
    print("Object " + (i+1) + " area: " + area);
}</code></pre>
</div>
<p>This macro opens the Blobs (25K) image, converts it to 8-bit, and analyzes particles. It then loops through the results table and prints the area of each object.</p>
<p><code>nResults</code> is a built-in variable that contains the number of rows in the results table. You can use it to loop through all the rows and extract data.</p>
<p><code>getResult("Area", i)</code> gets the area of the object in row i of the results table. You can replace “Area” with other column names to get different measurements.</p>
<p>You can also use the <code>setResult()</code> function to modify values in the results table. Add this code below the above code and check what area the first row is in the results table. It should read 999. <code>updateResults()</code> updates the results table to reflect the changes.</p>
<div class="gray-box">
<pre><code>setResult("Area", 0, 999);  // Change row 0's "Area" value to 999
updateResults();</code></pre>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: Add a New Column to the Results Table">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: Add a New Column to the Results Table
</div>
</div>
<div class="callout-body-container callout-body">
<p>After analyzing particles, calculate a new column called <code>"Half Area"</code> → it should be half of the <code>"Area"</code> column values.</p>
<p>Complete the loop:</p>
<pre class="ijm"><code>run("Blobs (25K)");
run("8-bit");
run("Make Binary");
run("Analyze Particles...", "size=0-Infinity show=Overlay display clear summarize");

for (i = 0; i &lt; _______; i++) {
    area = getResult("________", i);
    setResult("Half Area", i, area / 2);
}

__________;  // Refresh the table to show the new column</code></pre>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>run("Blobs (25K)");
run("8-bit");
run("Make Binary");
run("Analyze Particles...", "size=0-Infinity show=Overlay display clear summarize");

for (i = 0; i &lt; nResults; i++) {
    area = getResult("Area", i);
    setResult("Half Area", i, area / 2);
}

updateResults();</code></pre>
<p><code>setResult(column, row, value)</code> lets you add or update a value in the Results Table:</p>
<ul>
<li><p>column: the name of the column (e.g., “Area”, “Mean”, or your own, like “Half Area”)</p></li>
<li><p>row: which row to write into (starting from 0)</p></li>
<li><p>value: the number or text to insert</p></li>
</ul>
</details>
</div>
</div>
<section id="controlling-output-with-setmeasurements" class="level3">
<h3 class="anchored" data-anchor-id="controlling-output-with-setmeasurements">📐 Controlling Output with setMeasurements()</h3>
<p>By default, ImageJ might not show all the measurements you want (like Mean, Area, Min, Max, Integrated Density etc.). The <code>setMeasurements()</code> function lets you control what measurements are saved in the Results Table. You can see what measurements are available by going to <code>Analyze &gt; Set Measurements...</code> in the FIJI menu.</p>
<p>With setMeasurements(), you can:</p>
<ul>
<li><p>Select only the measurements you care about</p></li>
<li><p>Control which columns appear in the Results Table</p></li>
<li><p>Avoid clutter and make the table easier to work with</p></li>
<li><p>Ensure consistency when using getResult() later in your macro</p></li>
</ul>
<p>Open up the macro recorder by going to <code>Plugins &gt; Macros &gt; Record...</code> and run <code>Analyze &gt; Set Measurements...</code>. This will show you the options available. You can select or deselect the measurements you want to include in the Results Table.</p>
<p>e.g.&nbsp;</p>
<div class="gray-box">
<pre><code>run("Set Measurements...", "area mean standard modal min centroid center perimeter bounding fit shape feret's integrated median skewness kurtosis area_fraction stack redirect=None decimal=6");</code></pre>
</div>
<div class="{callout-tip}">
<p>I have a setMeasurements() function in every single macro I make. This way the results table will include the same measurements each time I or someone else runs it. This makes data analysis pipeline more streamlined - especially if you are inserting data into analysis tools like R or Python.</p>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Challenge: Customize the Measurements">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Challenge: Customize the Measurements
</div>
</div>
<div class="callout-body-container callout-body">
<p>You want to measure <strong>only the mean intensity and perimeter</strong> of the image. Use <code>setMeasurements()</code> to control what gets added to the Results Table.</p>
<pre><code>run("Blobs (25K)");
run("8-bit");
run("Make Binary");

run("Set Measurements...", "_______________________");
run("Measure");</code></pre>
<details>
<summary>
🔍 Show Solution
</summary>
<pre><code>run("Blobs (25K)");
run("8-bit");
run("Make Binary");

run("Set Measurements...", "mean perimeter");
run("Measure");</code></pre>
</details>
</div>
</div>
</section>
</section>
<section id="bonus-merging-channels" class="level2">
<h2 class="anchored" data-anchor-id="bonus-merging-channels">🌈 Bonus: Merging Channels</h2>
<p>One very common task in image analysis is to merge channels together. This can be done using the <code>Merge Channels</code> command in FIJI. But we will use macros to automate this process. The code for merging channels is not as intuitive as the other commands we have seen so far. It requires a specific format. This is why I have decided to include it here as a bonus section.</p>
<p>Why Merge Channels? Merging channels allows you to:</p>
<ul>
<li><p>Combine split grayscale images (C1, C2, C3…) into a single composite color image</p></li>
<li><p>Visualize multi-stain images with colors (e.g., red for BRN3A, green for ISLET1)</p></li>
<li><p>Export publication-ready RGB images</p></li>
</ul>
<p>After processing or splitting channels individually, you’ll often want to bring them back together for analysis or presentation.</p>
<p>So let’s start fresh with a new FIJI macro.</p>
<ol type="1">
<li><p>Open a new macro window in FIJI.</p></li>
<li><p>Open image sample-image1 in FIJI. This image of neurons has 4 channels. DAPI (nucleus), cell membrane stain, mitochondria stain and transmitted light. We should merge the Nucleus, cell membrane and mitochondria stain into one image.</p></li>
<li><p>Open up the macro recorder by going to</p></li>
</ol>
<div class="gray-box">
<p><code>🔎 Plugins &gt; Macros &gt; Record...</code></p>
</div>
<ol start="4" type="1">
<li>Then run split channels</li>
</ol>
<div class="gray-box">
<p><code>🔎 Image &gt; Color &gt; Split Channels</code></p>
</div>
<ol start="5" type="1">
<li>Now run the merge channels command</li>
</ol>
<div class="gray-box">
<p><code>🔎 Image &gt; Color &gt; Merge Channels...</code></p>
</div>
<ol start="6" type="1">
<li>In the merge channels dialog, select the channels you want to merge.</li>
</ol>
<ul>
<li><p>Select the first channel (e.g., C1) and choose a color (e.g., Blue)</p></li>
<li><p>Select the second channel (e.g., C2) and choose a color (e.g., Yellow)</p></li>
<li><p>Select the third channel (e.g., C3) and choose a color (e.g., Red)</p></li>
<li><p>Leave the fourth channel (e.g., C4) unselected as we want to leave out the transmitted light channel</p></li>
</ul>
<div class="gray-box">
<p><code>🔎 Image &gt; Color &gt; Merge Channels...</code></p>
</div>
<p><img src="quarto-images/macro-section10.png" class="img-fluid" width="300"></p>
<p>This will give:</p>
<div class="gray-box">
<pre><code>run("Merge Channels...", "c1=C3-sample-image1.tif c3=C1-sample-image1.tif c7=C2-sample-image1.tif create");</code></pre>
</div>
<p>What is happening here?</p>
<ul>
<li><p>c1=…, c2=…, c3=… … represent channel slots in the merge (Red = c1, Green = c2, Blue = c3, and so on). In reality, it doesn’t matter what color you choose, as long as you know which channel is which.</p></li>
<li><p>The filenames assigned to each slot (e.g., “C3-sample-image1.tif”) are the actual grayscale image windows open.</p></li>
<li><p>create means “create a new composite image from these inputs.”</p></li>
</ul>
<p>However, we want to keep our code generic, so that when we have another image this code will still work. We can use the <code>getTitle()</code> function to get the name of the image. This way, we can use the same macro for any image.</p>
<div class="gray-box">
<pre><code>title = getTitle(); // Get the title of the current image
run("Split Channels");
run("Merge Channels...", "c1=[C1-" + title + "] c2=[C2-" + title + "] c3=[C3-" + title + "] create");</code></pre>
</div>
<p>Take note of the capital letters and spaces. This is important in this case. Compare the recorder window output to this output.</p>
<ol start="7" type="1">
<li>Open sample-image3.tif and re-run the above code. You should see another image window open with the merged channels without the ransmitted light channel.</li>
</ol>
<hr>
</section>
<section id="exiting-the-macro" class="level2">
<h2 class="anchored" data-anchor-id="exiting-the-macro">🏁 Exiting the Macro</h2>
<p>There are a number of ways to let a user know when the macro has completed.</p>
<ol type="1">
<li>Display a pop-up window:</li>
</ol>
<div class="gray-box">
<pre><code>showMessage("Macro Complete", "All processing steps are done.");</code></pre>
</div>
<ol start="2" type="1">
<li>Print a message in the FIJI log window:</li>
</ol>
<div class="gray-box">
<pre><code>print("Macro finished successfully.");</code></pre>
</div>
<ol start="3" type="1">
<li>Make a sound:</li>
</ol>
<div class="gray-box">
<pre><code>beep();</code></pre>
</div>
<ol start="4" type="1">
<li>Exit message:</li>
</ol>
<div class="gray-box">
<pre><code>exit("Done");</code></pre>
</div>
<p>Try each one and see what you like best. You can also combine them.</p>
<hr>
</section>
<section id="batch-processing-folders-of-images" class="level2">
<h2 class="anchored" data-anchor-id="batch-processing-folders-of-images">📂 Batch Processing Folders of Images</h2>
<p>Now this macro only speeds up processing of individual images. Often we have tens to thousands of images to process. Even with this macro, opening each image individually and running the macro is time consuming. Instead, we can batch process folders of images using the same macro.</p>
<p>In batch processing you supply FIJI a set of files and a set of instructions, and it performs the same instructions on each file in the set and saves the results in a location of your choice.</p>
<p>Uses curly brackets {} (to denote a batch)</p>
<p>Using the existing macro, we can add a batch processing loop to the macro. This will allow us to process all images in a folder.</p>
<ol type="1">
<li>Add the following to the macro above the line <code>run("Z Project...", "projection=[Max Intensity]");</code></li>
</ol>
<div class="gray-box">
<pre><code>// ===== Setup Directories =====
// Choose source directory and create subdirectories for CSV results and ROI images.
dir = getDirectory("Choose Source Directory of images");
resultsDir = dir+"CSV_results/";
File.makeDirectory(resultsDir);

// Process all .tif files in the source directory.
processFolder(dir);
function processFolder(dir) {
    list = getFileList(dir);
    list = Array.sort(list);
    for (i = 0; i &lt; list.length; i++) {
        if (endsWith(list[i], ".tif")) {
            processFile(dir, resultsDir, list[i]);
        }
    }
} </code></pre>
</div>
<p><code>dir</code> is the source directory where the images are located. <code>resultsDir</code> is the directory where the results will be saved. The function <code>File.makeDirectory(resultsDir)</code> will make a new folder called CSV_results inside the dir filepath.</p>
<p>The <code>processFolder()</code> function processes all .tif files in the source directory. Here we a defining a function using curly braces { }. The <code>processFile()</code> function processes each file in the source directory. The <code>for</code> loop iterates through all files in the directory, and if the file ends with .tif, it calls the <code>processFile()</code> function to process that file.</p>
<p><code>list = getFileList(dir);</code> gets a list of all files in the directory dir and stores it in the variable list.</p>
<p><code>list = Array.sort(list);</code> This sorts the filenames alphabetically so that files are processed in a predictable order.</p>
<p><code>for (i = 0; i &lt; list.length; i++)</code> This is a loop that goes through each file in the list. The variable i is the index of the current file.</p>
<ul>
<li><p><code>i = 0</code>: Start at the first item in the list (position 0).</p></li>
<li><p><code>i &lt; list.length</code>: Keep going as long as i is less than the total number of items in the list (number of images).</p></li>
<li><p><code>i++</code>: Increase i by 1 after each loop iteration (move to the next image).</p></li>
</ul>
<details>
<summary>
🔍 Show Explanation
</summary>
<p>So, if your folder contains 5 files, this loop will run 5 times, and each time:</p>
<p>list[i]…</p>
<p>list[0] → first file</p>
<p>list[1] → second file</p>
<p>…</p>
<p>list[4] → fifth file</p>
</details>
<p><code>if (endsWith(list[i], ".tif")) { ... }</code> This checks if the current file (list[i]) ends with “.tif”. If it does, the code inside the curly braces { } will run. This is a way to filter out files that are not images.</p>
<p><code>processFile(dir, resultsDir, list[i]);</code> This calls the <code>processFile()</code> function to process the current file. The parameters passed to the function are:</p>
<ul>
<li><p><code>dir</code>: The source directory where the images are located.</p></li>
<li><p><code>resultsDir</code>: The directory where the results will be saved.</p></li>
<li><p><code>list[i]</code>: The name of the current file being processed.</p></li>
</ul>
<p><code>processFile()</code> is another function we will define later. It will contain the code that processes each image to your liking.</p>
<p>e.g.&nbsp;If your folder contains:</p>
<p>[“image1.tif”, “readme.txt”, “image2.tif”]</p>
<p>This loop will:</p>
<p>✅ Process image1.tif</p>
<p>❌ Skip readme.txt</p>
<p>✅ Process image2.tif</p>
<ol start="2" type="1">
<li>Now lets delete the original line of code that allows the user to save the results to a certain file.</li>
</ol>
<div class="gray-box">
<pre><code>dir = getDirectory("Choose Destination Directory"); // remove this line</code></pre>
</div>
<p>You should have something like this:</p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="quarto-images/macro-section8.png" class="img-fluid quarto-figure quarto-figure-left figure-img" width="700"></p>
</figure>
</div>
<ol start="3" type="1">
<li>Now we need to define the <code>processFile()</code> function. This function will contain the code that processes each image. We can copy and paste the code from the original macro into this function. Just below our <code>processFolder</code> function, add:</li>
</ol>
<div class="gray-box">
<pre><code>// ===== Process Each Image =====
function processFile(dir, resultsDir, file){
    // Open the image and get its title.
    open(dir + File.separator + file);
    title = getTitle();</code></pre>
</div>
<p>This section of your macro defines a <strong>custom function</strong> called <code>processFile()</code>. This function is used to process <strong>one image at a time</strong> — and it gets called inside the loop that handles all <code>.tif</code> files that we defined above. The function takes three parameters:</p>
<ul>
<li><p><code>dir</code>: The source directory where the images are located.</p></li>
<li><p><code>resultsDir</code>: The directory where the results will be saved.</p></li>
<li><p><code>file</code>: The name of the current file being processed.</p></li>
</ul>
<p><code>open(dir + File.separator + file);</code> opens the image file. It builds the full file path using:</p>
<p><code>dir</code>: folder path (e.g., “C:/Images/”)</p>
<p><code>File.separator</code>: the slash (/ or , depending on operating system)</p>
<p><code>file</code>: the image filename (e.g., “sample-image1.tif”)</p>
<details>
<summary>
🔍 Show Explanation
</summary>
<p>So if dir = “C:/Images” and file = “image1.tif”, this line becomes:</p>
<pre><code>open("C:/Images/image1.tif");</code></pre>
<p>This opens the image file in FIJI.</p>
</details>
<p><code>title = getTitle();</code> After the image opens, this line stores the image’s title (window name) in a variable called title. This title will be used later in the macro for naming saved files or identifying what’s currently being processed.</p>
<ol start="4" type="1">
<li><p>Notice we have now defined <code>title</code> twice. Once inside our <code>processFile()</code> function and once at the start of the macro. We can remove the first instance of <code>title = getTitle();</code> from the macro, as it is now defined inside the <code>processFile()</code> function.</p></li>
<li><p>Now our previous code is nestled inside the <code>processFile()</code> function. We need to add a closing curly brace } at the end of the macro to close the function. After the line <code>saveAs("Results", dir + "Summary_" + title + ".csv");</code> add the closing curly brace }.</p></li>
<li><p>Ah but wait! We need to change the <code>saveAs()</code> lines to use the new <code>resultsDir</code> variable we created earlier. This will save the results in the CSV_results folder we created at the start of the macro rather than where the images are stored. This keeps everything organised.</p></li>
</ol>
<div class="gray-box">
<pre><code>selectWindow("Results");
saveAs("Results", resultsDir + "Results_" + title + ".csv");
selectWindow("Summary");
saveAs("Results", resultsDir + "Summary_" + title + ".csv");</code></pre>
</div>
<ol start="7" type="1">
<li>Now lets add some cleaning up code to close the image and clear the results before looping to the next image. This will help keep FIJI running smoothly and free up memory. At the end of the <code>processFile()</code> function, add:</li>
</ol>
<div class="gray-box">
<pre><code>if (isOpen("Results")) close("Results");
if (isOpen("Summary")) close("Summary");
roiManager("Deselect"); // Ensure no ROIs are selected
close("*"); // Close all open images

// Sometimes windows need encouraging to close. So we can specfy them by name:
close("Results_" + title + ".csv");
close("Summary_" + title + ".csv");
close("ROI Manager");</code></pre>
</div>
<ol start="8" type="1">
<li>Then outside of the closing curly brace } of the <code>processFile()</code> function, we can add an exit message:</li>
</ol>
<div class="gray-box">
<pre><code>exit("Done");</code></pre>
</div>
<ol start="9" type="1">
<li>Save the sample-image1.tif and sample-image2.tif to a folder. Then run the macro on the folder of images. Check the output files. You should see a new folder called CSV_results in the same directory as your images. Inside this folder should be the results and summary files for each image.</li>
</ol>
<details>
<summary>
🔍 Show the full code
</summary>
<pre><code>// USAGE: Use in FIJI
//
// Author: Marnie L Maddock (University of Wollongong)
// mmaddock@uow.edu.au, mlm715@uowmail.edu.au
// 5.07.2024
// Count number of Objects in a Channel

/*
This macro will take an image and:
1. Run a max projection,
2. Split the channels,
3. Unsharp mask, 
4. Convert to binary,
5. Analyze particles (count objects),
6. Save the results and summary files.
*/

// Instructions
// Have a folder of tif images
// Press run on macro
// Select folder with tif images
// Specify which channel the objects you want to count
// Macro will automatically run. A pop-up box will appear once the macro has completed.

// ===== Setup Directories =====
// Choose source directory and create subdirectories for CSV results and ROI images.
dir = getDirectory("Choose Source Directory of images");
resultsDir = dir+"CSV_results/";
File.makeDirectory(resultsDir);


// create a pop-up box that allows user to specify what channel to count objects in
Dialog.create("Specify Channel Number to Count Objects");
Dialog.addNumber("Channel number for analyze particles", 1); // Instructions, with 1 being default
Dialog.show; // Display dialog box

// save number entered by user to channel_num
channel_num = Dialog.getNumber();

// Process all .tif files in the source directory.
processFolder(dir);
function processFolder(dir) {
    list = getFileList(dir);
    list = Array.sort(list);
    for (i = 0; i &lt; list.length; i++) {
        if (endsWith(list[i], ".tif")) {
            processFile(dir, resultsDir, list[i]);
        }
    }
} 

// ===== Process Each Image =====
function processFile(dir, resultsDir, file){
    // Open the image and get its title.
    open(dir + File.separator + file);
    title = getTitle();
    
    // Make max projection of z stack
    run("Z Project...", "projection=[Max Intensity]");
    //Split the channels
    run("Split Channels");
    //Select the image window to be counted (as specified by channel_num
    selectImage("C" + channel_num + "-MAX_" + title);
    // Sharpen image using unsharp mask
    run("Unsharp Mask...", "radius=1 mask=0.60");
    // Make image binary
    setOption("BlackBackground", true);
    run("Convert to Mask");
    // Count objects
    run("Analyze Particles...", "  show=Overlay display exclude clear summarize add");
    
    // ===== Save Results =====
    selectWindow("Results");
    saveAs("Results", resultsDir + "Results_" + title + ".csv");
    selectWindow("Summary");
    saveAs("Results", resultsDir + "Summary_" + title + ".csv");
    
    if (isOpen("Results")) close("Results");
    if (isOpen("Summary")) close("Summary");
    roiManager("Deselect"); // Ensure no ROIs are selected
    close("*"); // Close all open images
    
    // Sometimes windows need encouraging to close. So we can specfy them by name:
    close("Results_" + title + ".csv");
    close("Summary_" + title + ".csv");
    close("ROI Manager");
}

exit("Done");</code></pre>
</details>
<p>It runs so fast! It is now processing all images in the folder and saving the results in a new folder called CSV_results. This is a great start to automating analysis.</p>
<hr>
</section>
<section id="final-touches" class="level2">
<h2 class="anchored" data-anchor-id="final-touches">📖 Final Touches</h2>
<section id="add-a-license" class="level3">
<h3 class="anchored" data-anchor-id="add-a-license">📄 Add a License</h3>
<p>If you are sharing your code, you may want to add a license. A license tells other people:</p>
<ul>
<li>✅ What they can and can’t do with your code</li>
<li>✅ Whether they can reuse it in their own projects</li>
<li>✅ How they should give you credit</li>
</ul>
<p>Some popular licenses include:</p>
<ul>
<li><strong>MIT License</strong> – very open and permissive</li>
<li><strong>GPL (General Public License)</strong> – requires derived code to also be open</li>
<li><strong>Creative Commons (e.g.&nbsp;CC-BY)</strong> – common for educational material and data</li>
</ul>
<blockquote class="blockquote">
<p>🧭 You can explore license types at <a href="https://choosealicense.com">choosealicense.com</a></p>
</blockquote>
<p>We can add a license to our code by creating a file called <code>LICENSE</code> in the same folder as our macro. This file should contain the text of the license you choose. Otherwise, you can directly copy the lisence info to the top of the macro. For example, if you choose the MIT License, your <code>LICENSE</code> file or text would look like this:</p>
<div class="gray-box">
<pre><code>MIT License
Copyright (c) 2024 Marnie L Maddock
Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), 
to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, 
and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</code></pre>
</div>
</section>
<section id="sharing-your-code" class="level3">
<h3 class="anchored" data-anchor-id="sharing-your-code">📄 Sharing Your Code</h3>
<p>The best way to share code is to use a version control system like Git. This allows you to keep track of changes, collaborate with others, and share your code easily.</p>
<p><a href="https://github.com">GitHub</a> is a popular platform that lets you store and publish your code online.<br>
You can upload your macro scripts, images, and tutorials so others can use and contribute to them.</p>
<p>Here’s how to get started:</p>
<ol type="1">
<li>Create a free account at <a href="https://github.com">github.com</a></li>
<li>Click <strong>“New repository”</strong> and give your project a name</li>
<li>Add your <code>.ijm</code> files, documentation, and a <code>LICENSE</code> file</li>
<li>Write a <code>README.md</code> to explain what your macro does</li>
<li>(Optional) Use Git to push updates from your local computer</li>
</ol>
<blockquote class="blockquote">
<p>🧭 Learn more at: <a href="https://docs.github.com/en/get-started" class="uri">https://docs.github.com/en/get-started</a></p>
</blockquote>
<p>💡 GitHub makes it easier for others to find your code, give feedback, and cite your work!</p>
<hr>
</section>
</section>
<section id="troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="troubleshooting">🛠️ Troubleshooting</h2>
<p>Writing macros is a learning process, and errors are very normal! When something goes wrong, ImageJ usually gives you an error message that helps you figure out what’s wrong.</p>
<ul>
<li><p><strong>Spelling</strong> — Make sure all function names (like <code>run</code>, <code>Dialog.create</code>) and variable names are spelled correctly.</p></li>
<li><p><strong>Brackets</strong> — Check that every opening <code>(</code>, <code>{</code>, or <code>[</code> has a matching closing one.</p></li>
<li><p><strong>Capitalization</strong> — <code>Dialog.getString()</code> is not the same as <code>dialog.getstring()</code> — ImageJ is case-sensitive!</p></li>
<li><p><strong>Semicolons</strong> — Most lines must end with a <code>;</code>. Forgetting one is one of the most common causes of errors.</p></li>
<li><p><strong>Quotes for Strings</strong> — Strings must be wrapped in double quotes: <code>"Hello"</code> not <code>Hello</code>.</p></li>
<li><p><strong>Line Numbers in Errors</strong> — The error message usually tells you what line it occurred on, <strong>but it’s not always exact</strong> — check the lines just above and below too.</p></li>
<li><p><strong>Start small</strong> — If you’re stuck, comment out sections of your macro and run it in smaller chunks.</p></li>
<li><p><strong>Use <code>print()</code> for debugging</strong> — You can print variables to the log to see what values are being stored.</p></li>
<li><p>use <strong>wait()</strong> to slow down the macro if it is running too fast. This can help you see what is happening at each step. Is useful for debugging and for running your analysis.</p></li>
<li><p>If you don’t know where to start, or how to write a piece of code, start by using the <strong>macro recorder</strong>. The macro recorder will record your actions in FIJI and give you a starting point.</p></li>
<li><p>Before running on a full dataset, make sure the macro works on a <strong>single image</strong>.</p></li>
<li><p>If your macro is running <strong>slowly</strong>, restart FIJI or your computer to clear memory. Often macros run faster when you have less open, so if you have images building up that do not close, add lines of code that close the image before looping to the next image.</p></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>I find my macros run much faster if I do not have Google chrome open, chrome eats up so much of your RAM…</p>
</div>
</div>
<hr>
</section>
<section id="a-note-about-.lif-files" class="level2">
<h2 class="anchored" data-anchor-id="a-note-about-.lif-files">📦 A note about .lif files</h2>
<p>If you have .lif files, these need to be converted to individual .tif images prior to batch processing.</p>
<p>If you are using .lif files, you can use the <code>Lif-to-Tif</code> macro to convert them to .tif files. This macro will open the .lif file and save each image in the file as a separate .tif file. This macro was created by Alexandre Hego: alexandre.hego@uliege.be. It works really well for .lif project files, including .lif files with tilescans. I have added this macro to my GitHub page for accessibility <a href="https://github.com/MarnieMaddock/Lif-to-Tif">Lif-to-Tif</a>.</p>
<hr>
</section>
<section id="explore-my-macro-collection" class="level2">
<h2 class="anchored" data-anchor-id="explore-my-macro-collection">🔗 Explore My Macro Collection</h2>
<p>If you are looking for inspiration, or want to see some examples of macros I have made, check out my GitHub page. These get updated regularly. Try running them yourself with the provided sample images in each repository to see how they work. Make sure to read the README file before starting! Feel free to use these macros for analysing your own images if applicable. However, please cite the work if you do so. Refer to the license file in each repository for more information.</p>
<p>If you come across any issues, or want some features added to the macros, please let me know. Requests can be made through GitHub by going to the repository and clicking on the issues tab. Here you can submit a request for a new feature, or report a bug.</p>
<p>Currently available macros include:</p>
<ul>
<li><p><a href="https://github.com/MarnieMaddock/Lif-to-Tif" class="uri">Lif-to-Tif</a></p></li>
<li><p><a href="https://github.com/MarnieMaddock/Double-Positive-Nuclei">Double-Positive-Nuclei</a></p></li>
<li><p><a href="https://github.com/MarnieMaddock/Double-Positive-Nuclei-With-Checks">Double-Positive-Nuclei-With-Checks</a></p></li>
<li><p><a href="https://github.com/MarnieMaddock/Double-Triple-Positive-Nuclei-With-Checks">Double-Triple-Positive-Nuclei-With-Checks</a></p></li>
<li><p><a href="https://github.com/MarnieMaddock/Neuron_Confluence">Neuron_Confluence</a></p></li>
<li><p>More to come!</p></li>
</ul>
<hr>
</section>
<section id="feedback" class="level2">
<h2 class="anchored" data-anchor-id="feedback">Feedback</h2>
<p>If you’ve found this resource useful, please consider <strong>sharing it with your colleagues, students, or lab mates</strong>. The more people who benefit from it, the better!</p>
<p>I’m always looking to improve this guide. If you:</p>
<ul>
<li>🐛 Found a bug or error in the macro code</li>
<li>❓ Think a topic could be explained better</li>
<li>📚 Have a suggestion for a new section or feature</li>
<li>💡 Created your own macro and want to contribute it</li>
</ul>
<p>…I would love to hear from you!</p>
<p>You can submit feedback or suggest changes by <a href="https://github.com/MarnieMaddock/FIJI-macro-tutorial/issues">opening an issue on GitHub</a>.</p>
<blockquote class="blockquote">
<p>🛠️ Don’t worry if you’re not a GitHub pro — even just pointing out a typo is helpful!</p>
</blockquote>
<p>Thank you for helping make this guide better for everyone!</p>
</section>
<section id="contacts" class="level2">
<h2 class="anchored" data-anchor-id="contacts">Contacts</h2>
<p>If you have any questions, comments, or suggestions, please feel free to reach out to me:</p>
<ul>
<li>📧 <a href="mailto:mlm715@uowmail.edu.au">Email</a></li>
<li>💻 <a href="https://github.com/MarnieMaddock">GitHub</a></li>
<li>🐦 <a href="https://x.com/marniemaddock">Twitter</a></li>
<li>🌐 <a href="https://orcid.org/0000-0001-6393-4837">ORCID</a></li>
</ul>
<p>The FIJI-macro-tutorial is housed <a href="https://marniemaddock.github.io/FIJI-macro-tutorial/FIJI-macro-tutorial.html">here</a></p>
<p>The repository for this project is available <a href="https://github.com/MarnieMaddock/FIJI-macro-tutorial">here</a></p>
</section>
<section id="license" class="level2">
<h2 class="anchored" data-anchor-id="license">LICENSE</h2>
<p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
</p><p><span property="dct:title">FIJI-macro-tutorial</span> by <span property="cc:attributionName">Marnie Maddock</span> is licensed under <a href="https://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY 4.0<img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"></a></p>
<p></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/marniemaddock\.github\.io\/FIJI-macro-tutorial\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>